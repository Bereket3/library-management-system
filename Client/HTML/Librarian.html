<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Librarian Dashboard</title>
  <link rel="stylesheet" href="../CSS/Librarian.css">
  <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="container">
        <a href="#home" class="logo"><img src="../img/EduShelf_  Managing Books with Ease.jpg" alt="EduShelf"><h1>EduShelf</h1></a>
        <ul class="nav-links">
          <li><a href="#home" class="active">HOME</a></li>
          <li><a href="../HTML/home.html" id="LogOut">LogOut</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <main>
    <section class="book-grid">
      <div class="container">
        <h2>Available Books</h2>
        <div class="grid">
          <div class="book-item">
            <img src="../img/book1.png" alt="Book Title 1">
            <h3>Dreams and Stories</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book2.png" alt="Book Title 2">
            <h3>Flight Book</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book3.png" alt="Book Title 3">
            <h3>Life</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book4.png" alt="Book Title 4">
            <h3>Winter</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book5.png" alt="Book Title 5">
            <h3>Be Modest</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book6.png" alt="Book Title 6">
            <h3>Report</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book7.png" alt="Book Title 7">
            <h3>Annual Report</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book8.png" alt="Book Title 8">
            <h3>Book Cover</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
          <div class="book-item">
            <img src="../img/book2.png" alt="Book Title 8">
            <h3>Flight Book</h3>
            <p>by Author Name</p>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </div>
        </div>
      </div>
    </section>

    <section class="" id="approvals-section">
      <h2 class="text-center py-5">Pending User Approvals</h2>
      <div id="errorContainer" class="bg-gradient-danger text-center"></div>
      <div class="px-4 d-flex flex-column " id="pending-users"></div>
    </section>
  </main>

  <div id="book-modal" class="modal">
    <div class="modal-content">
      <h3 id="bookModalTitle">Add Book</h3>
      <input type="text" id="bookTitle" placeholder="Enter your name">
      <input type="email" id="editEmail" placeholder="Enter Email">
      <input type="file" id="bookCover" accept="image/*"> 
      <button id="saveBookBtn" class="cta">Save</button>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 Library Management System. All rights reserved.</p>
    </div>
  </footer>
  <script src="../TS/Librarian.js"></script> 
  <script src="../bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    const BASE_URL = "http://localhost:7000/"
    const pendingUsers = document.getElementById("pending-users");
    const errorContainer = document.getElementById('errorContainer');

    function displayError(message) {
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible fade show';
        errorAlert.role = 'alert';
        errorAlert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        errorContainer.appendChild(errorAlert);
    }

    async function approveUser(userId, isApproved) {
      const data = new FormData()
      data.append("userId", userId)
      data.append("isApproved", isApproved ? "true" : "false")
      const toSend = Object.fromEntries(data)

      const options = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem('Token')}`,
        },
        body: JSON.stringify(toSend)
      }
      fetch(BASE_URL + 'auth/approve/', options)
      .then(async res => {
        if(res.status !== 200) {
          switch (res.status) {
            case 401:
              displayError("It seens your session has ended. Log again!")
              setTimeout(() => window.location.href = "./home.html", 1000)
              break;
            case 403:
              displayError("You Don't have permission to do these action")
              break
            default:
              displayError("There is un expected error!")
              break;
          }
        } else {
          const removableElement = document.getElementById(`user_${userId}`)
          removableElement.remove()
        }
      })
    }

    async function collectUsers() {
      const options = {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        },
      }
      fetch(BASE_URL + 'auth/filter-by-approval/?isApproved=false', options)
      .then(async res => await res.json())
      .then(res => {
        res.forEach((user) => {
          if(!user.isApproved && !user.isReject) {
            const userHTML = `
              <div class="alert alert-warning alert-dismissible fade show" id="user_${user._id}" role="alert">
                <strong>Name: ${user.name}</strong>
                <p>Email: ${user.email}</p>
                <p>Role: ${user.role.join(', ')}</p>
                <button type="button" class="btn btn-primary" onclick="approveUser('${user._id}', ${true})">Approve</button>
                <button type="button" class="btn btn-danger float-end" onclick="approveUser('${user._id}', ${false})">Reject</button>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            pendingUsers.innerHTML += userHTML;
          }
        });
      })
      .catch(err => console.log(err))
    }

    document.addEventListener("DOMContentLoaded", collectUsers())
  </script>
</body>
</html>